<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EduGenie Peer Room</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 12px;}
    #container { display:flex; gap:12px; }
    #notes { flex:1; }
    #canvas { flex:1; border:1px solid #ddd; background:white; }
    textarea { width:100%; height:300px; }
    canvas { width:100%; height:300px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <h3>EduGenie â€” Peer Room</h3>
  <div id="container">
    <div id="notes">
      <label>Shared Notes</label>
      <textarea id="sharedNotes"></textarea>
    </div>
    <div id="canvas">
      <label>Whiteboard</label>
      <canvas id="wb"></canvas>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Firebase config and JWT token injected from Streamlit
    const firebaseConfig = window.firebaseConfig;  // injected from Streamlit
    const roomToken = window.roomToken;           // injected from Streamlit
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || 'default';

    // JWT validation (basic, optional server-side validation recommended)
    try {
      const payload = JSON.parse(atob(roomToken.split('.')[1]));
      if(payload.room !== room){
        alert("Invalid room token!");
        throw "Invalid token";
      }
    } catch(e){
      console.error("Token validation failed", e);
    }

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Shared Notes
    const notesRef = db.ref('rooms/' + room + '/notes');
    const ta = document.getElementById('sharedNotes');
    ta.addEventListener('input', () => {
      notesRef.set({text: ta.value, ts: Date.now()});
    });
    notesRef.on('value', snap => {
      const v = snap.val();
      if(v && v.text !== ta.value) ta.value = v.text;
    });

    // Whiteboard
    const canvas = document.getElementById('wb');
    canvas.width = canvas.clientWidth;
    canvas.height = 300;
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', (e) => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    canvas.addEventListener('mousemove', (e) => {
      if(drawing){ ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }
    });
    canvas.addEventListener('mouseup', () => {
      drawing = false;
      canvasRef.set({image: canvas.toDataURL(), ts: Date.now()});
    });

    const canvasRef = db.ref('rooms/' + room + '/canvas');
    canvasRef.on('value', snap => {
      const v = snap.val();
      if(v && v.image){
        const img = new Image();
        img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
        img.src = v.image;
      }
    });

    // Optional: Load your Lottie animation from assets
    const lottieContainer = document.createElement('div');
    lottieContainer.id = 'lottieAnim';
    document.body.appendChild(lottieContainer);
    // Example using lottie-web (add your assets path)
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js";
    script.onload = () => {
      lottie.loadAnimation({
        container: document.getElementById('lottieAnim'),
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: '/assets/your_animation.json'  // <-- replace with your animation
      });
    };
    document.body.appendChild(script);
  </script>
</body>
</html>
